FROM node:20.13.1-bookworm-slim

WORKDIR /opt/app

COPY package.json yarn.lock ./

RUN yarn install --frozen-lockfile

COPY . /opt/app

ARG NODE_ENV
ARG CORS_ORIGIN
ARG MAIN_DATABASE_URL
ARG STRIPE_SECRET_KEY
ARG STRIPE_WEBHOOK_SECRET
ARG AUTH0_DOMAIN
ARG AUTH0_API_AUDIENCE
ARG FINSECURED_API_KEY
ARG PORT
ARG AI_API_URL

ENV NODE_ENV=${NODE_ENV}
ENV CORS_ORIGIN=${CORS_ORIGIN}
ENV MAIN_DATABASE_URL=${MAIN_DATABASE_URL}
ENV STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
ENV STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
ENV AUTH0_DOMAIN=${AUTH0_DOMAIN}
ENV AUTH0_API_AUDIENCE=${AUTH0_API_AUDIENCE}
ENV FINSECURED_API_KEY=${FINSECURED_API_KEY}
ENV PORT=${PORT}
ENV AI_API_URL=${AI_API_URL}

RUN yarn install --production=false && yarn build

EXPOSE ${PORT}

CMD ["node", "dist/index.js"]
